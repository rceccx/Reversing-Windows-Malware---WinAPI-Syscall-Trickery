#!/bin/bash

OUT_DIR="./compiled/"
CC=x86_64-w64-mingw32-g++
SYMBOLS=true

if [ "$SYMBOLS" = true ]; then FLAGS=""; else FLAGS="-s"; fi

if [ -d "${OUT_DIR}/" ]; then rm -rf "${OUT_DIR}/"; fi
mkdir "${OUT_DIR}/";
cp ./shellcode.bin "${OUT_DIR}/"

echo "[*] Compiling winapi example.";
$CC -m64 $FLAGS -static -O2 ./example_winapi.c -I"/usr/share/mingw-w64/include/" \
    -L"/usr/x86_64-w64-mingw32/lib/" -ffunction-sections -fdata-sections \
    -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ \
    -static-libgcc -fpermissive -lrpcrt4 -Wno-multichar -o "${OUT_DIR}/example_winapi.exe"

echo "[*] Compiling syscalls example.";
$CC -m64 $FLAGS -static -O2 ./example_syscalls.c "../SysWhispers2-fork/out/syscalls_all.c" \
"../SysWhispers2-fork/out/syscalls_all_stubs.std.x64.s" -I"../SysWhispers2-fork/out/" \
-I"/usr/share/mingw-w64/include/" -L"/usr/x86_64-w64-mingw32/lib/" -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive -lrpcrt4 -Wno-multichar -o "${OUT_DIR}/example_syscalls.exe"

echo "[*] Compiling syscalls random example.";
$CC -m64 $FLAGS -static -O2 ./example_syscalls.c "../SysWhispers2-fork/out/syscalls_all.c" \
"../SysWhispers2-fork/out/syscalls_all_stubs.rnd.x64.s" -I"../SysWhispers2-fork/out/" \
-I"/usr/share/mingw-w64/include/" -L"/usr/x86_64-w64-mingw32/lib/" -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive -lrpcrt4 -Wno-multichar -DRANDSYSCALL -o "${OUT_DIR}/example_syscalls_rnd.exe"

echo "Done!";